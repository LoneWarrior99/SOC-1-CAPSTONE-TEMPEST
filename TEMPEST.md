## Tempest Incident 
In this incident, you will act as an Incident Responder from an alert triaged by one of your Security Operations Center analysts. The analyst has confirmed that the alert has a CRITICAL severity that needs further investigation.
As reported by the SOC analyst, the intrusion started from a malicious document. In addition, the analyst compiled the essential information generated by the alert as listed below:
The malicious document has a .doc extension.
The user downloaded the malicious document via chrome.exe.
The malicious document then executed a chain of commands to attain code execution.

## Intial Access - Malicious Document

### The user of this machine was compromised by a malicious document. What is the file name of the document?

Report stated that intrusion started from a malicious doc file with .doc extension. Used Timeline Explorer and searched for “.doc” to find file name.

![Screenshot 2024-10-02 115312](https://github.com/user-attachments/assets/58845415-7843-4085-9027-b1407cd5275a)



### What is the name of the compromised user and machine?

We can use the same line we used last time to find Username and machine name:
benimaru-TEMPEST


### What is the PID of the Microsoft Word process that opened the malicious document?

Opened with Winword.exe from Benimaru we can look under Payload Data1 on the same line to see PID : 496

### Based on Sysmon logs, what is the IPv4 address resolved by the malicious domain used in the previous question?

What we know: PID:496, DNS Query EventID:22.
Filter for these and we can find query results under Payload Data6
167.71.199.191

![Screenshot 2024-09-30 104212](https://github.com/user-attachments/assets/1cfc93dd-aa48-4f43-b754-b800408969cb)


### What is the base64 encoded string in the malicious payload executed by the document?

What we know: Parent ID should be 496, Process creation event id: 1
Filter for this and we can find the answer under executable info

![Screenshot 2024-09-30 104825](https://github.com/user-attachments/assets/b7ccc0cf-266a-4408-a4c6-808adfddc4f6)



### What is the CVE number of the exploit used by the attacker to achieve a remote code execution?

Looking at the contents we can see the initial .exe and we can search for that on google to see if there are any matches.

![Screenshot 2024-09-30 110134](https://github.com/user-attachments/assets/d33192c4-0ab1-4f99-9c52-2651545aced7)

![Screenshot 2024-09-30 110305](https://github.com/user-attachments/assets/7005f0ac-ca8a-4c0d-96ea-6abef0651202)






## Malicious Document - Stage 2

Based on the initial findings, we discovered that there is a stage 2 execution:
The document has successfully executed an encoded base64 command.
Decoding this string reveals the exact command chain executed by the malicious document.

### Investigation Guide
With the following discoveries, we may refer again to the cheatsheet to continue with the investigation:
The Autostart execution reflects explorer.exe as its parent process ID.
Child processes of explorer.exe within the event timeframe could be significant.
Process Creation (Event ID 1) and File Creation (Event ID 11) succeeding the document execution are worth checking.

### Initial Access - Stage 2 execution


### The malicious execution of the payload wrote a file on the system. What is the full target path of the payload?

Filter for File Creation (Event ID 11) and startup under payload data4 

![Screenshot 2024-09-30 115255](https://github.com/user-attachments/assets/ae5889f7-9666-4555-8a01-fe6c8326c827)


  
### The implanted payload executes once the user logs into the machine. What is the executed command upon a successful login of the compromised user?

Refer to the Guide, Filter for Process Creation (Event ID 1) and contains parent process explorer, and user Benimaru

![Screenshot 2024-09-30 122042](https://github.com/user-attachments/assets/39a2af8f-369d-4691-b2ac-3be8ff76c119)


### Based on Sysmon logs, what is the SHA256 hash of the malicious binary downloaded for stage 2 execution?

We can keep the same event id and username filter but we want to look at the child process, first.exe under the executable info
We can find the sha256 under payload data3 under its original path

![Screenshot 2024-09-30 124215](https://github.com/user-attachments/assets/be39eb8a-9d47-46af-9d28-c430027e260d)


### The stage 2 payload downloaded establishes a connection to a c2 server. What is the domain and port used by the attacker?

Using sysmon view to assist, we can look at the GUI view for first.exe and see the answer

![Screenshot 2024-09-30 132119](https://github.com/user-attachments/assets/570c6da0-f457-4a54-a665-99c7ff16d671)



## Initial Access - Malicious Document Traffic
### Malicious Document Traffic
Based on the collected findings, we discovered that the attacker fetched the stage 2 payload remotely:
We discovered the Domain and IP invoked by the malicious document on Sysmon logs.
There is another domain and IP used by the stage 2 payload logged from the same data source.

### Investigation Guide
Since we have discovered network-related artefacts, we may again refer to our cheatsheet, which focuses on Network Log Analysis:
We can now use Brim and Wireshark to investigate the packet capture.
Find network events related to the harvested domains and IP addresses.
Sample Brim filter that you can use for this investigation: _path=="http" "<malicious domain>"
Data Sources:
Packet Capture


### What is the URL of the malicious payload embedded in the document?

Using Wireshark we will filter for the host we already know and search GET request
Right after the magicules.doc we see the url

![Screenshot 2024-09-30 134518](https://github.com/user-attachments/assets/4631e05b-8d2f-49ef-9a58-57ae363c3bb1)



### What is the encoding used by the attacker on the c2 connection?

We decoded the url earlier using base64, we can look at the values using Brim under http requests and double check to see if we can second the value with base64 which we can.

![Screenshot 2024-09-30 135318](https://github.com/user-attachments/assets/d1436191-0e2e-4aea-a616-204bf10a2b49)


### The malicious c2 binary sends a payload using a parameter that contains the executed command results. What is the parameter used by the binary?

We can look at the value from before and determine that is is “q”


### The malicious c2 binary connects to a specific URL to get the command to be executed. What is the URL used by the binary?

We can see that is /9ab62b5 from all the entries in Brim

![Screenshot 2024-09-30 140351](https://github.com/user-attachments/assets/659afa8a-812c-4e06-95ca-674be8cd4c69)



### What is the HTTP method used by the binary?

Same as last question we can see that they are get requests

### Based on the user agent, what programming language was used by the attacker to compile the binary?

Here we need to look at wireshark’s info, if we take a look at http.request get method and choose an entry with base64 information, we can see the useragent below.

![Screenshot 2024-09-30 140546](https://github.com/user-attachments/assets/d565cb89-956c-412f-9725-d9f4e784352f)





## Discovery - Internal Reconnaissance
### Internal Reconnaissance

Based on the collected findings, we have discovered that the malicious binary continuously uses the C2 traffic:
We can easily decode the encoded string in the network traffic.
The traffic contains the command and output executed by the attacker.

### Investigation Guide

To continue with the investigation, we may focus on the following information:
Find network and process events connecting to the malicious domain.
Find network events that contain an encoded command.
We can use Brim to filter all packets containing the encoded string.
Look for endpoint enumeration commands since the attacker is already inside the machine.
In addition, we may refer to our cheatsheet for Brim to quickly investigate the encoded traffic with the following filters:
To get all HTTP requests related to the malicious C2 traffic: _path=="http" "<replace domain>" id.resp_p==<replace port> | cut ts, host, id.resp_p, uri | sort ts
Significant Data Sources:
Packet Capture
Sysmon



### The attacker was able to discover a sensitive file inside the machine of the user. What is the password discovered on the aforementioned file?

We can use the filter given to us to individually look through the file and decode the one by one and use our best guess to find where it is.

![Screenshot 2024-09-30 141520](https://github.com/user-attachments/assets/4fc3c401-a07b-49af-9446-8a9ea6db0404)

![Screenshot 2024-09-30 141526](https://github.com/user-attachments/assets/78e1e00e-b599-4795-af3e-4d84c8c201a5)

### The attacker then enumerated the list of listening ports inside the machine. What is the listening port that could provide a remote shell inside the machine?

Using context clues we can look above the entries and find a netstat code was ran,

![Screenshot 2024-09-30 141728](https://github.com/user-attachments/assets/38e10cca-d43c-439a-8bf7-299c3abbbef5)

![Screenshot 2024-09-30 141817](https://github.com/user-attachments/assets/85d4a373-845b-4459-a19c-c55a4c807daa)

Looking at these open ports we can tell that a notorious port (listening port of winrm) is being used.


### The attacker then established a reverse socks proxy to access the internal services hosted inside the machine. What is the command executed by the attacker to establish the connection?

We can go back to timeline viewer here and look for socks

![Screenshot 2024-09-30 142219](https://github.com/user-attachments/assets/306e016d-387d-4271-a3cf-d569a2c16639)


### What is the SHA256 hash of the binary used by the attacker to establish the reverse socks proxy connection?

Using the same info for the last question we can scroll to the left and find the sha256
8A99353662CCAE117D2BB22EFD8C43D7169060450BE413AF763E8AD7522D2451

### What is the name of the tool used by the attacker based on the SHA256 hash? Provide the answer in lowercase.

Use Virustotal and search for hash
Under details we found chisel.exe


### The attacker then used the harvested credentials from the machine. Based on the succeeding process after the execution of the socks proxy, what service did the attacker use to authenticate?

Look chronologically after the socks, we find:

![Screenshot 2024-09-30 142828](https://github.com/user-attachments/assets/de6363fd-1747-48d6-89df-a451a3c6506e)

Googling the exe will find winrm





## Privilege Escalation - Exploiting Privileges
### Privilege Escalation
Based on the collected findings, the attacker gained a stable shell through a reverse socks proxy.

### Investigation Guide

With this, we can focus on the following network and endpoint events:
Look for events executed after the successful execution of the reverse socks proxy tool.
Look for potential privilege escalation attempts, as the attacker has already established a persistent low-privilege access.


### After discovering the privileges of the current user, the attacker then downloaded another binary to be used for privilege escalation. What is the name and the SHA256 hash of the binary?

Following the flow we can see that the next exe is spf.exe, we can search through it in timeline and find the sha256 that points to its original file location

![Screenshot 2024-09-30 143959](https://github.com/user-attachments/assets/ed809b9b-d0d0-4e76-a92c-35c35a81b789)


###Based on the SHA256 hash of the binary, what is the name of the tool used?

Take the hash into VirusTotal and look into details
PrintSpoofer.exe

![Screenshot 2024-09-30 144254](https://github.com/user-attachments/assets/de081347-38c7-4dd9-b414-eb261c057a15)

### The tool exploits a specific privilege owned by the user. What is the name of the privilege?

I just looked up printspoofer into google and found a github link


###Then, the attacker executed the tool with another binary to establish a c2 connection. What is the name of the binary?

Follow the data flow again to find final.exe

![Screenshot 2024-09-30 144440](https://github.com/user-attachments/assets/55632f58-4f1c-41e7-b1e9-46172b06c5d5)


### The binary connects to a different port from the first c2 connection. What is the port used?

Just like before we will use sysmon view to find the path and port

![Screenshot 2024-09-30 144612](https://github.com/user-attachments/assets/4d81003d-ba42-403b-baea-643f437decc8)

Port 8080




## Actions on Objective - Fully-owned Machine
### Fully-Owned Machine
Now, the attacker has gained administrative privileges inside the machine. Find all persistence techniques used by the attacker.
In addition, the unusual executions are related to the malicious C2 binary used during privilege escalation.

### Investigation Guide
Now, we can rely on our cheatsheet to investigate events after a successful privilege escalation:
Useful Brim filter to get all HTTP requests related to the malicious C2 traffic : _path=="http" "<replace domain>" id.resp_p==<replace port> | cut ts, host, id.resp_p, uri | sort ts
The attacker gained SYSTEM privileges; now, the user context for each malicious execution blends with NT Authority\System.
All child events of the new malicious binary used for C2 are worth checking.


### Upon achieving SYSTEM access, the attacker then created two users. What are the account names?

Using Brim we can use the filter provided and manually search and decode the values

![Screenshot 2024-09-30 145155](https://github.com/user-attachments/assets/bba3f191-708d-4e53-bc3d-e4ee4ef6e859)

Shuna, Shion

### Prior to the successful creation of the accounts, the attacker executed commands that failed in the creation attempt. What is the missing option that made the attempt fail?

Looking at the code they tried to input in ps, 

![Screenshot 2024-09-30 145630](https://github.com/user-attachments/assets/46977377-eeaa-4680-9f00-8e18a1d485b1)

We can tell he is missing /add


### Based on windows event logs, the accounts were successfully created. What is the event ID that indicates the account creation activity?

We can google this, 4720

### The attacker added one of the accounts in the local administrator's group. What is the command used by the attacker?

We can find the commands made in Timeline as well following the data,

![Screenshot 2024-09-30 150249](https://github.com/user-attachments/assets/7860e490-e659-4d2a-a87e-4ceb1bdc4fc7)


### Based on windows event logs, the account was successfully added to a sensitive group. What is the event ID that indicates the addition to a sensitive local group?

Google to find this :4732


### After the account creation, the attacker executed a technique to establish persistent administrative access. What is the command executed by the attacker to achieve this?

Looking through the timeline we can find this sch task

![Screenshot 2024-09-30 150550](https://github.com/user-attachments/assets/dbf91cc0-4637-41a7-adbc-f614b10d6a47)






















